!function(){"use strict";function t(t){return t.x*t.x+t.y*t.y}var e;!function(e){function n(t){const{x:e,y:n}=t;return Math.sqrt(e*e+n*n)}e.create=function(t=0,e=0){return{x:t,y:e}},e.distanceSquared=function(t,e){const n=t.x-e.x,o=t.y-e.y;return n*n+o*o},e.lengthSquared=t,e.length=n,e.normalize=function(t,e){let o=n(t);o>0&&(o=e/o,t.x*=o,t.y*=o)}}(e||(e={}));const n=Math.round,o=Math.random,i=Math.sin,a=Math.cos,s=Math.atan2,r=Math.abs,c=Math.max,h=Math.min,l=Math.sqrt,d=2*Math.PI;function u(t,e){return n(t+o()*(e-t))}function f(t,e){return t+o()*(e-t)}var p;!function(t){t.transformColor=function(t,e){let n=t>>24&255,o=t>>16&255,i=t>>8&255,a=255&t;return n=n*e.am+e.ao&255,o=o*e.rm+e.ro&255,i=i*e.gm+e.go&255,a=a*e.bm+e.bo&255,`rgba(${o}, ${i}, ${a}, ${n/255})`},t.formatColor=function(t){return`rgba(${t>>16&255}, ${t>>8&255}, ${255&t}, ${(t>>24&255)/255})`}}(p||(p={}));function y(t,e,n,s,r,c,h,l,d){let f=u(r,c);t.push(4,f);const p=2*Math.PI/f;for(void 0===d&&(d=Math.PI*o());f--;)t.push(n+i(d)*u(h,l),s+a(d)*u(h,l)),d+=p;t.push(0,e)}class m{constructor(t){this.actions=new Map,this.transitions=[],this._state=-1,this._reactionTime=0,this._time=0,this._reactionTime=t}setState(t,e){this._state=t;const n=this.getAction();n&&n.start(e)}getAction(){const t=this.actions.get(this._state);if(!t)throw"Action not found: "+this._state;return t}update(t){const e=this.getAction();if(e&&e.update(t),this._time-=t,this._time<=0){this._time=this._reactionTime+this._reactionTime*o();for(const t of this.transitions){const{from:e,to:n}=t;if(n!==this._state&&(0===e.length||e.includes(this._state))&&t.condition()){this.setState(n,t.data);break}}}}}var g;!function(t){t[t.PLAYER=0]="PLAYER",t[t.NPC=1]="NPC",t[t.ENEMY=2]="ENEMY"}(g||(g={}));const x=new Map;function w(t,e){return t===e||x.get(t)===x.get(e)}function b(t){const{radius:e,weight:n,color:o,type:i,health:a}=t,s=[o,4278190080],r=new m(t.reaction),c={radius:e,weight:n},h=[];return y(h,0,0,0,5,5,e,e,Math.PI/10),y(h,1,e/2,0,3,3,e/3,e/3,Math.PI/2),{type:i,shape:h,pallete:s,rotation:0,x:0,y:0,fsm:r,body:c,health:a,settings:t,weapon:0,onUpdate(t){this.fsm.update(t)}}}var v,E,T;function P(t){const n={type:2,radius:30,weight:60,health:100,color:4288217088,walkSpeed:100,reaction:.5,enemyDistance:300,weapons:[{damage:3,speed:100,points:[e.create(30,0)],frequency:1,distance:10,color:4294901760,length:10,width:10}]},{units:r}=t,c=b(n),{walkSpeed:h}=n,l=n.enemyDistance,u=l*l;c.rotation=d*o();const{fsm:p}=c,{actions:y,transitions:m}=p;function g(t){const n=e.distanceSquared(t,c),o=c.body.radius+t.body.radius;return n<1.1*(o*o)}return y.set(0,{data:{},time:0,update(t){c.rotation+=this.data.speed*t,this.time-=t},start(){this.data.speed=o()>.5?-1:1,this.time=f(.5,2)}}),y.set(1,{data:{},time:0,update(t){c.x+=this.data.speedX*t,c.y+=this.data.speedY*t,this.time-=t},start(){this.data.speedX=a(c.rotation)*h,this.data.speedY=i(c.rotation)*h,this.time=f(1,3)}}),y.set(2,{data:{},time:0,update(t){c.rotation=s(this.data.target.y-c.y,this.data.target.x-c.x);const e=a(c.rotation)*h,n=i(c.rotation)*h;c.x+=e*t,c.y+=n*t},start(t){this.data.target=t}}),y.set(3,{data:{},time:0,update(t){this.time-=t,this.time<=0&&this.start(this.data.target)},start(t){this.data.target=t;const e=n.weapons[c.weapon];t.health-=e.damage,this.time=1/e.frequency}}),y.set(4,{data:{},time:0,update(t){},start(){c.alpha=.5,c.body.enabled=!1}}),m.push({from:[1],to:0,condition:()=>p.getAction().time<0}),m.push({from:[0],to:1,condition:()=>p.getAction().time<0}),m.push({from:[0,1],to:2,condition(){for(const t of r)if(!w(t.type,c.type)&&t.health>0){if(e.distanceSquared(t,c)<u)return this.data=t,!0}return!1}}),m.push({from:[2,3],to:0,condition(){const t=p.getAction().data.target;if(t.health<=0)return!0;return e.distanceSquared(t,c)>1.5*u}}),m.push({from:[2],to:3,condition(){const t=p.getAction().data.target;return!!g(t)&&(this.data=t,!0)}}),m.push({from:[3],to:2,condition(){const t=p.getAction().data.target;return!g(t)&&(this.data=t,!0)}}),m.push({from:[],to:4,condition:()=>c.health<=0}),p.setState(0),c}x.set(1,0),x.set(0,1),function(t){t[t.ROTATE=0]="ROTATE",t[t.WALK=1]="WALK",t[t.GOTO_TARGET=2]="GOTO_TARGET",t[t.ATTACK=3]="ATTACK",t[t.DEAD=4]="DEAD"}(v||(v={}));class A{constructor(t,n){this.direction=e.create(),this.attack=!1,this.rotation=0,this.weapon=0,this.up=!1,this.down=!1,this.right=!1,this.left=!1,this.player=t,this.keyProcess=this.keyProcess.bind(this),n.onTouchMove=e=>{this.rotation=s(e.y-t.y,e.x-t.x)},n.onTouchDown=t=>{this.attack=!0},n.onTouchUp=t=>{this.attack=!1},n.onKeyDown=this.keyProcess,n.onKeyUp=this.keyProcess}keyProcess(t){const n="keydown"===t.type;switch(t.code){case"KeyW":case"ArrowUp":this.up=n;break;case"KeyS":case"ArrowDown":this.down=n;break;case"KeyA":case"ArrowLeft":this.left=n;break;case"KeyD":case"ArrowRight":this.right=n;break;case"Space":n&&this.player.settings.weapons&&(this.weapon++,this.weapon>=this.player.settings.weapons.length&&(this.weapon=0))}this.direction.x=0,this.direction.y=0,this.up&&(this.direction.y-=1),this.down&&(this.direction.y+=1),this.left&&(this.direction.x-=1),this.right&&(this.direction.x+=1),e.normalize(this.direction,1)}}class k{constructor(){this.direction=e.create(),this.attack=!1,this.rotation=0,this.weapon=0}}function S(t,n,o,s,r,c){const h={x:s.speed*a(o),y:s.speed*i(o)};let l=0;const d=e.length(h),{length:u,width:f,color:p}=s,y=f/2,m={x:t,y:n,rotation:o,body:{weight:0,radius:3,transparent:!0},shape:[4,3,-u,0,0,-y,0,y,0,0],pallete:[p],onUpdate(t){this.x+=h.x*t,this.y+=h.y*t,l+=d*t,l>s.distance&&c.removeBullet(m)},onCollision(t,e){if("health"in t){const e=t;w(e.type,r)||(e.health-=s.damage/s.points.length,c.removeBullet(m))}}};return m}function M(t){const n=e.create(30,0),o={type:0,radius:30,weight:90,health:100,color:4278229401,walkSpeed:200,reaction:.2,weapons:[{damage:20,points:[n],frequency:3,speed:1e3,distance:1e3,color:4294967295,length:30,width:4},{damage:40,points:[e.create(30,-5),e.create(30,5)],frequency:10,speed:1500,distance:1e3,color:4294967040,length:50,width:3},{damage:150,points:new Array(10).fill(n),frequency:1,speed:1e3,distance:300,color:4278255615,length:10,width:3,angle:.7}]},s=b(o),r=function(t,e){return"ontouchstart"in window?new k:new A(t,e)}(s,t),{fsm:c}=s,{actions:h,transitions:l}=c,{walkSpeed:d}=o,u=function(t,e){let n=0,o=0;return(s,r)=>{if(r&&t.settings.weapons){const r=t.settings.weapons[t.weapon];if(n-=s,n<=0){n=1/r.frequency;const{rotation:s,type:c}=t;if(r.angle){let n=s-r.angle/2;const o=r.angle/r.points.length;for(const s of r.points){const h=a(n),l=i(n),{x:d,y:u}=s,f=S(t.x+d*h-u*l,t.y+d*l+u*h,n,r,c,e);e.addBullet(f),n+=o}}else{o++,o>=r.points.length&&(o=0);const n=a(s),h=i(s),{x:l,y:d}=r.points[o],u=S(t.x+l*n-d*h,t.y+l*h+d*n,s,r,c,e);e.addBullet(u)}}}else n=0}}(s,t);return h.set(0,{data:{},time:0,update(t){const e=d*t;s.x+=r.direction.x*e,s.y+=r.direction.y*e,s.rotation=r.rotation,s.weapon=r.weapon,u(t,r.attack)},start(){}}),h.set(1,{data:{},time:0,update(t){},start(){s.alpha=.5,s.body.enabled=!1}}),l.push({from:[],to:1,condition:()=>s.health<=0}),c.setState(0),s}!function(t){t[t.ALIVE=0]="ALIVE",t[t.DEAD=1]="DEAD"}(E||(E={})),function(t){t[t.SIZE=0]="SIZE",t[t.FILL=1]="FILL",t[t.RECTANGLE=2]="RECTANGLE",t[t.ELLIPSE=3]="ELLIPSE",t[t.LINE=4]="LINE",t[t.REPEAT=5]="REPEAT",t[t.NOISE=6]="NOISE"}(T||(T={}));const D=new Map;D.set(0,((t,e,n)=>{const o=n.fillStyle;e.width=t.width,e.height=t.height,n.fillStyle=o,n.fillRect(0,0,e.width,e.height)})),D.set(1,((t,e,n)=>{n.fillStyle=p.formatColor(t.color)})),D.set(2,((t,e,n)=>{n.fillRect(t.x,t.y,t.width,t.height)})),D.set(3,((t,e,n)=>{const o=t.width/2,i=t.height/2;n.beginPath(),n.ellipse(t.x+o,t.y+i,o,i,0,0,2*Math.PI),n.closePath(),n.fill()})),D.set(5,((t,e,n,o)=>{const i=D.get(o.type),a=o.x,s=t.stepX,r=t.stepY,c=t.cols;let h=t.count,l=1;for(o.x+=s;h--;)i(o,e,n,o),o.x+=s,l++,l===c&&(l=0,o.x=a,o.y+=r)})),D.set(6,((t,e,n)=>{const i=t.colorOffset,a=i/2,s=n.getImageData(0,0,e.width,e.height),r=s.data;let c=0;for(;c<r.length;){const t=r[c],e=r[c+1],n=r[c+2];r[c]=t-a+i*o(),r[c+1]=e-a+i*o(),r[c+2]=n-a+i*o(),c+=4}n.putImageData(s,0,0)}));const I=[{type:1,color:4284900966},{type:0,width:512,height:512},{type:1,color:4286023799},{type:2,x:20,y:20,width:50,height:50},{type:5,stepX:70,stepY:70,count:48,cols:7},{type:1,color:4284900966},{type:2,x:140,y:140,width:220,height:220},{type:1,color:4286023799},{type:3,x:160,y:160,width:190,height:190}];function L(){const t={image:function(t){const e=document.createElement("canvas"),n=e.getContext("2d");let o;return t.forEach((t=>{D.get(t.type)(t,e,n,o),o=t})),e}(I),x:-256,y:-256},e=Math.sqrt(262144)/2,n=[];for(let o=0;o<10;o++)for(let i=0;i<10;i++)n.push({x:511*(o-5),y:511*(i-5),radius:e,children:[t]});return{children:n}}const C=e.create();function q(){const n=[],o=[],i=[];return{units:o,children:[L(),{children:o},{children:i}],onUpdate(o){!function(n,o){for(let o=0;o<n.length;o++){const i=n[o],a=i.body;if(!1!==a.enabled)for(let s=o+1;s<n.length;s++){const o=n[s],r=o.body;if(!1!==r.enabled){const n=a.radius+r.radius,s=n*n;C.x=i.x-o.x,C.y=i.y-o.y;const c=t(C);if(c<s){if(!a.transparent&&!r.transparent){const t=l(c),s=(n-t)/t,h=C.x*s,d=C.y*s,u=a.weight,f=r.weight,p=u+f,y=f/p,m=u/p;i.x+=h*y,i.y+=d*y,o.x-=h*m,o.y-=d*m,C.x=i.x-o.x,C.y=i.y-o.y,e.normalize(C,r.radius),C.x+=o.x,C.y+=o.y}i.onCollision&&i.onCollision(o,C),o.onCollision&&o.onCollision(i,C)}}}}}(n)},addUnit(t){o.push(t),n.push(t)},removeUnit(t){o.splice(o.indexOf(t),1),n.splice(n.indexOf(t),1)},addBullet(t){i.push(t),n.push(t)},removeBullet(t){i.splice(i.indexOf(t),1),n.splice(n.indexOf(t),1)}}}function R(t){const n=function(){const t=e.create(),n=q(),i=M(n);n.addUnit(i);for(let t=0;t<10;t++){const t=P(n);t.x=1e3*o()-500,t.y=1e3*o()-500,n.addUnit(t)}return{camera:t,children:[n],size:2500,updateCamera(){var t;this.camera.x=i.x,this.camera.y=i.y,null===(t=this.children)||void 0===t||t.forEach((t=>{t.x=-this.camera.x,t.y=-this.camera.y}))},calculateVolume(n){const o=l(e.distanceSquared(t,n));return 1-h(1,c(0,o/1250))}}}();return{children:[n],updateView(e){const o=t.getWidth(),i=t.getHeight(),a=h(o/1024,i/1024);n.scale=a,n.x=o/2,n.y=i/2,n.updateCamera(e)}}}var U,_;!function(t){t.empty=function(){return{am:1,rm:1,gm:1,bm:1,ao:0,ro:0,go:0,bo:0}},t.concat=function(t,e,n){const o=t.am*e.am,i=t.rm*e.rm,a=t.gm*e.gm,s=t.bm*e.bm,r=t.am*e.ao+t.ao,c=t.rm*e.ro+t.ro,h=t.gm*e.go+t.go,l=t.bm*e.bo+t.bo;n.am=o,n.rm=i,n.gm=a,n.bm=s,n.ao=r,n.ro=c,n.go=h,n.bo=l}}(U||(U={})),function(t){function e(t){return t.a*t.d-t.b*t.c}t.empty=function(){return{a:1,b:0,c:0,d:1,x:0,y:0}},t.concat=function(t,e,n){const o=e.a*t.a+e.b*t.c,i=e.a*t.b+e.b*t.d,a=e.c*t.a+e.d*t.c,s=e.c*t.b+e.d*t.d,r=e.x*t.a+e.y*t.c+t.x,c=e.x*t.b+e.y*t.d+t.y;n.a=o,n.b=i,n.c=a,n.d=s,n.x=r,n.y=c},t.getScale=function(t){return c(r(t.a),r(t.b),r(t.c),r(t.d))},t.transformPoint=function(t,e,n){const{x:o,y:i}=e;n.x=o*t.a+i*t.c,n.y=o*t.b+i*t.d},t.getDeterminant=e,t.transformInversePoint=function(t,n,o){let i=e(t);if(0===i)o.x=-t.x,o.y=-t.y;else{i=1/i;const{x:e,y:a}=n;o.x=i*(t.c*(t.y-a)+t.d*(e-t.x)),o.y=i*(t.a*(a-t.y)+t.b*(t.x-e))}}}(_||(_={}));const K=_.empty();var O;!function(t){function e(t,e){var n,o,i,a,s,r;const{rotation:c}=t,h=null!==(o=null!==(n=t.scaleX)&&void 0!==n?n:t.scale)&&void 0!==o?o:1,l=null!==(a=null!==(i=t.scaleY)&&void 0!==i?i:t.scale)&&void 0!==a?a:1;if(e.x=null!==(s=t.x)&&void 0!==s?s:0,e.y=null!==(r=t.y)&&void 0!==r?r:0,c){const t=Math.cos(c),n=Math.sin(c);return e.a=t*h,e.b=n*h,e.c=-n*l,void(e.d=t*l)}e.a=h,e.b=0,e.c=0,e.d=l}t.getMatrix=e,t.getColorTransform=function(t,e){var n;const o=null!==(n=t.alpha)&&void 0!==n?n:1,{tint:i}=t;if(i){const{color:t=0,value:n=1}=i,a=1-n,s=t>>16&255,r=t>>8&255,c=255&t;return e.am=o,e.rm=a,e.gm=a,e.bm=a,e.ao=0,e.ro=s*n,e.go=r*n,void(e.bo=c*n)}let{brightness:a}=t;if(void 0!==a){a>1?a=1:a<-1&&(a=-1);const t=1-Math.abs(a);let n=0;return a>0&&(n=255*a),e.am=o,e.rm=t,e.gm=t,e.bm=t,e.ao=0,e.ro=n,e.go=n,void(e.bo=n)}e.am=o,e.rm=1,e.gm=1,e.bm=1,e.ao=0,e.ro=0,e.go=0,e.bo=0},t.transformPoint=function(t,n,o){const{x:i,y:a}=n;e(t,K),o.x=i*K.a+a*K.c+K.x,o.y=i*K.b+a*K.d+K.y}}(O||(O={}));const Y=e.create();var $;!function(t){t.render=function t(e,n,o,i){var a;if(e.onScreen=!1,!(null===(a=e.visible)||void 0===a||a))return;const s=_.empty();if(O.getMatrix(e,s),_.concat(n,s,s),e.radius){const t=_.getScale(s)*e.radius;if(s.x+t<0||s.y+t<0||s.x-t>i.canvas.width-0||s.y-t>i.canvas.height-0)return}const r=U.empty();if(O.getColorTransform(e,r),U.concat(o,r,r),r.am<=0)return;e.onScreen=!0,i.setTransform(s.a,s.b,s.c,s.d,s.x,s.y);const{shape:c,image:h,pallete:l,text:d,children:u}=e;c&&l&&function(t,e,n,o){for(let i=0;i<t.length;i++)switch(t[i]){case 0:o.fillStyle=p.transformColor(e[t[++i]],n),o.fill();break;case 1:o.strokeStyle=p.transformColor(e[t[++i]],n),o.lineWidth=t[++i],o.stroke();break;case 2:o.beginPath(),o.moveTo(t[++i],t[++i]);break;case 3:o.lineTo(t[++i],t[++i]);break;case 4:let a=t[++i];for(a--,o.beginPath(),o.moveTo(t[++i],t[++i]);a--;)o.lineTo(t[++i],t[++i]);break;default:throw`unknown command: ${t[i]}`}}(c,l,r,i),d&&function(t,e,n){var o,i,a;if(!t.value)return;n.fillStyle=p.transformColor(null!==(o=t.color)&&void 0!==o?o:4278190080,e),n.font=`${null!==(i=t.size)&&void 0!==i?i:10}px ${null!==(a=t.font)&&void 0!==a?a:"arial"}`,n.textBaseline="top";let s=0;t.align&&(s=-n.measureText(t.value).width*t.align),n.fillText(t.value,s,0)}(d,r,i),h&&function(t,e,n){n.fillStyle=n.createPattern(t,"no-repeat"),n.fillRect(0,0,t.width,t.height)}(h,0,i),u&&u.forEach((e=>t(e,s,r,i)))},t.update=function t(e,n){if(!1===e.enabled)return;e.onUpdate&&e.onUpdate(n);const{children:o}=e;o&&o.forEach((e=>t(e,n)))},t.keyProcess=function t(e,n,o){switch(o){case 1:e.onKeyDown&&e.onKeyDown(n);break;case 0:e.onKeyUp&&e.onKeyUp(n)}const{children:i}=e;i&&i.forEach((e=>t(e,n,o)))},t.touchProcess=function t(e,n,o,i){if(!1===e.touchable)return;const a=_.empty();switch(O.getMatrix(e,a),_.concat(o,a,a),i){case 1:e.onTouchDown&&(_.transformInversePoint(a,n,Y),e.onTouchDown(Y,n));break;case 0:e.onTouchUp&&(_.transformInversePoint(a,n,Y),e.onTouchUp(Y,n));break;case 2:e.onTouchMove&&(_.transformInversePoint(a,n,Y),e.onTouchMove(Y,n))}const{children:s}=e;s&&s.forEach((e=>t(e,n,a,i)))}}($||($={}));const N=_.empty(),B=U.empty(),W=devicePixelRatio;var X;!function(t){let e,n;t.render=function(t){!function(){const t=innerWidth*W|0,e=innerHeight*W|0;t!==n.width&&(n.width=t);e!==n.height&&(n.height=e);N.a=N.d=W}(),e.setTransform(),e.fillStyle="#bbbbbb",e.fillRect(0,0,n.width,n.height),$.render(t,N,B,e)},t.init=function(t){n=t,e=n.getContext("2d")}}(X||(X={}));var G=function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function s(t){try{c(o.next(t))}catch(t){a(t)}}function r(t){try{c(o.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,r)}c((o=o.apply(t,e||[])).next())}))};const z=document.getElementById("c");let V;X.init(z);let H=performance.now();function F(){requestAnimationFrame(F);const t=function(){const t=performance.now(),e=t-H;return H=t,e/1e3}();$.update(V,t),V.updateView(t),X.render(V)}!function(){G(this,void 0,void 0,(function*(){V=R({getWidth:()=>innerWidth,getHeight:()=>innerHeight}),H=performance.now(),F(),document.addEventListener("keydown",(t=>{$.keyProcess(V,t,1),t.preventDefault()})),document.addEventListener("keyup",(t=>{$.keyProcess(V,t,0),t.preventDefault()})),z.addEventListener("mousedown",(t=>{const e={x:t.clientX*W,y:t.clientY*W};$.touchProcess(V,e,N,1),t.preventDefault()})),z.addEventListener("mouseup",(t=>{const e={x:t.clientX*W,y:t.clientY*W};$.touchProcess(V,e,N,0),t.preventDefault()})),z.addEventListener("mousemove",(t=>{const e={x:t.clientX*W,y:t.clientY*W};$.touchProcess(V,e,N,2),t.preventDefault()}))}))}()}();
