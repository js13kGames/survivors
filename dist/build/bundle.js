!function(){"use strict";function t(t){return t.x*t.x+t.y*t.y}var e;!function(e){function n(t){const{x:e,y:n}=t;return Math.sqrt(e*e+n*n)}e.create=function(t=0,e=0){return{x:t,y:e}},e.distanceSquared=function(t,e){const n=t.x-e.x,o=t.y-e.y;return n*n+o*o},e.lengthSquared=t,e.length=n,e.normalize=function(t,e){let o=n(t);o>0&&(o=e/o,t.x*=o,t.y*=o)}}(e||(e={}));const n=Math.round,o=Math.random,i=Math.sin,a=Math.cos,r=Math.atan2,s=Math.abs,c=Math.max,h=Math.min,d=Math.sqrt,u=2*Math.PI;function l(t,e){return n(t+o()*(e-t))}function f(t,e){return t+o()*(e-t)}var m;!function(t){t.transformColor=function(t,e){let n=t>>24&255,o=t>>16&255,i=t>>8&255,a=255&t;return n=n*e.am+e.ao&255,o=o*e.rm+e.ro&255,i=i*e.gm+e.go&255,a=a*e.bm+e.bo&255,`rgba(${o}, ${i}, ${a}, ${n/255})`},t.formatColor=function(t){return`rgba(${t>>16&255}, ${t>>8&255}, ${255&t}, ${(t>>24&255)/255})`}}(m||(m={}));function y(t,e,n,r,s,c,h,d,u){let f=l(s,c);t.push(4,f);const m=2*Math.PI/f;for(void 0===u&&(u=Math.PI*o());f--;)t.push(n+i(u)*l(h,d),r+a(u)*l(h,d)),u+=m;t.push(0,e)}class p{constructor(){this.actions=new Map,this.transitions=[],this._state=-1,this._updateTime=0,this._time=0}setUpdateTime(t){this._updateTime=t}setState(t,e){this._state=t;const n=this.getAction();n&&n.start(e)}getAction(){const t=this.actions.get(this._state);if(!t)throw"Action not found: "+this._state;return t}update(t){const e=this.getAction();if(e&&e.update(t),this._time-=t,this._time<=0){this._time=this._updateTime+this._updateTime*o();for(const t of this.transitions)if(t.from.includes(this._state)&&t.condition()){this.setState(t.to,t.data);break}}}}var g;!function(t){t[t.PLAYER=0]="PLAYER",t[t.NPC=1]="NPC",t[t.ENEMY=2]="ENEMY"}(g||(g={}));const x=new Map;function b(t,n,o,i,a,r){const s=[],c=[a,4278190080],h=e.create(),d=e.create(),u=new p,l={radius:n,weight:o};return y(s,0,0,0,5,5,n,n,Math.PI/10),y(s,1,n/2,0,3,3,n/3,n/3,Math.PI/2),{type:t,shape:s,pallete:c,rotation:0,x:0,y:0,speed:h,targetSpeed:d,direction:{up:!1,down:!1,left:!1,right:!1},walkSpeed:r,fsm:u,body:l,health:i,onUpdate(t){this.fsm.update(t),this.targetSpeed.x=0,this.targetSpeed.y=0,this.direction.up&&(this.targetSpeed.y-=1),this.direction.down&&(this.targetSpeed.y+=1),this.direction.left&&(this.targetSpeed.x-=1),this.direction.right&&(this.targetSpeed.x+=1),e.normalize(this.targetSpeed,this.walkSpeed),this.speed.x+=(this.targetSpeed.x-this.speed.x)/3,this.speed.y+=(this.targetSpeed.y-this.speed.y)/3,this.x+=this.speed.x*t,this.y+=this.speed.y*t}}}var v,w;function S(t){const n=b(2,30,60,100,4288217088,100);n.rotation=u*o();const{fsm:s}=n;s.setUpdateTime(.5),s.actions.set(0,{data:{},time:0,update(t){n.rotation+=this.data.speed*t,this.time-=t},start(){this.data.speed=o()>.5?-1:1,this.time=f(.5,2)}}),s.actions.set(1,{data:{},time:0,update(t){n.x+=this.data.speedX*t,n.y+=this.data.speedY*t,this.time-=t},start(){const t=f(50,100);this.data.speedX=a(n.rotation)*t,this.data.speedY=i(n.rotation)*t,this.time=f(1,3)}}),s.actions.set(2,{data:{},time:0,update(t){n.rotation=r(this.data.target.y-n.y,this.data.target.x-n.x);const e=a(n.rotation)*this.data.speed,o=i(n.rotation)*this.data.speed;n.x+=e*t,n.y+=o*t},start(t){this.data.speed=f(50,100),this.data.target=t}}),s.actions.set(3,{data:{},time:0,update(t){this.time-=t},start(t){this.time=1,this.data.target=t,t.health-=10,console.log(t.health)}}),s.transitions.push({from:[1],to:0,condition:()=>s.getAction().time<0}),s.transitions.push({from:[0],to:1,condition:()=>s.getAction().time<0});return s.transitions.push({from:[0,1],to:2,condition(){for(const a of t)if(i=n,(o=a).type!==i.type&&x.get(o.type)!==x.get(i.type)&&a.health>0){if(e.distanceSquared(a,n)<9e4)return this.data=a,!0}var o,i;return!1}}),s.transitions.push({from:[2],to:0,condition(){const t=s.getAction().data.target;if(t.health<=0)return!0;return e.distanceSquared(t,n)>135e3}}),s.transitions.push({from:[2],to:3,condition(){const t=s.getAction().data.target,o=e.distanceSquared(t,n),i=n.body.radius+t.body.radius;return o<1.1*(i*i)&&(this.data=t,!0)}}),s.transitions.push({from:[3],to:2,condition(){return s.getAction().time<0&&(this.data=s.getAction().data.target,!0)}}),s.setState(0),n}x.set(1,0),x.set(0,1),function(t){t[t.ROTATE=0]="ROTATE",t[t.WALK=1]="WALK",t[t.GOTO_TARGET=2]="GOTO_TARGET",t[t.ATTACK=3]="ATTACK"}(v||(v={})),function(t){t[t.SIZE=0]="SIZE",t[t.FILL=1]="FILL",t[t.RECTANGLE=2]="RECTANGLE",t[t.ELLIPSE=3]="ELLIPSE",t[t.LINE=4]="LINE",t[t.REPEAT=5]="REPEAT",t[t.NOISE=6]="NOISE"}(w||(w={}));const T=new Map;T.set(0,((t,e,n)=>{const o=n.fillStyle;e.width=t.width,e.height=t.height,n.fillStyle=o,n.fillRect(0,0,e.width,e.height)})),T.set(1,((t,e,n)=>{n.fillStyle=m.formatColor(t.color)})),T.set(2,((t,e,n)=>{n.fillRect(t.x,t.y,t.width,t.height)})),T.set(3,((t,e,n)=>{const o=t.width/2,i=t.height/2;n.beginPath(),n.ellipse(t.x+o,t.y+i,o,i,0,0,2*Math.PI),n.closePath(),n.fill()})),T.set(5,((t,e,n,o)=>{const i=T.get(o.type),a=o.x,r=t.stepX,s=t.stepY,c=t.cols;let h=t.count,d=1;for(o.x+=r;h--;)i(o,e,n,o),o.x+=r,d++,d===c&&(d=0,o.x=a,o.y+=s)})),T.set(6,((t,e,n)=>{const i=t.colorOffset,a=i/2,r=n.getImageData(0,0,e.width,e.height),s=r.data;let c=0;for(;c<s.length;){const t=s[c],e=s[c+1],n=s[c+2];s[c]=t-a+i*o(),s[c+1]=e-a+i*o(),s[c+2]=n-a+i*o(),c+=4}n.putImageData(r,0,0)}));const E=[{type:1,color:4284900966},{type:0,width:512,height:512},{type:1,color:4286023799},{type:2,x:20,y:20,width:50,height:50},{type:5,stepX:70,stepY:70,count:48,cols:7},{type:1,color:4284900966},{type:2,x:140,y:140,width:220,height:220},{type:1,color:4286023799},{type:3,x:160,y:160,width:190,height:190}];function A(){const t={image:function(t){const e=document.createElement("canvas"),n=e.getContext("2d");let o;return t.forEach((t=>{T.get(t.type)(t,e,n,o),o=t})),e}(E),x:-256,y:-256},e=Math.sqrt(262144)/2,n=[];for(let o=0;o<10;o++)for(let i=0;i<10;i++)n.push({x:511*(o-5),y:511*(i-5),radius:e,children:[t]});return{children:n}}const P=e.create();function M(){const n=e.create(),i=[],a=[];function s(t){a.push(t),i.push(t)}const u={children:[A(),{children:a}]},l=function(t,e){const n=b(0,30,90,100,4278229401,200),{fsm:o}=n;return o.actions.set(0,{data:{},time:0,update(t){},start(){}}),o.setState(0),t.onTouchMove=t=>{n.rotation=r(t.y-n.y,t.x-n.x)},n.onKeyDown=t=>{switch(t.code){case"KeyW":case"ArrowUp":n.direction.up=!0;break;case"KeyS":case"ArrowDown":n.direction.down=!0;break;case"KeyA":case"ArrowLeft":n.direction.left=!0;break;case"KeyD":case"ArrowRight":n.direction.right=!0}},n.onKeyUp=t=>{switch(t.code){case"KeyW":case"ArrowUp":n.direction.up=!1;break;case"KeyS":case"ArrowDown":n.direction.down=!1;break;case"KeyA":case"ArrowLeft":n.direction.left=!1;break;case"KeyD":case"ArrowRight":n.direction.right=!1}},n}(u);s(l);for(let t=0;t<10;t++){const t=S(a);t.x=1e3*o()-500,t.y=1e3*o()-500,s(t)}return{camera:n,shakingTime:0,children:[u],size:2500,onUpdate(e){!function(e,n){for(let n=0;n<e.length;n++){const o=e[n],i=o.body;for(let a=n+1;a<e.length;a++){const n=e[a],r=n.body,s=i.radius+r.radius,c=s*s;P.x=o.x-n.x,P.y=o.y-n.y;const h=t(P);if(h<c){const t=d(h),e=(s-t)/t,a=P.x*e,c=P.y*e,u=i.weight,l=r.weight,f=u+l,m=l/f,y=u/f;o.x+=a*m,o.y+=c*m,n.x-=a*y,n.y-=c*y}}}}(i)},updateCamera(){var t;this.camera.x=l.x,this.camera.y=l.y,null===(t=this.children)||void 0===t||t.forEach((t=>{t.x=-this.camera.x,t.y=-this.camera.y}))},calculateVolume(t){const o=d(e.distanceSquared(n,t));return 1-h(1,c(0,o/1250))}}}var k,I;!function(t){t.empty=function(){return{am:1,rm:1,gm:1,bm:1,ao:0,ro:0,go:0,bo:0}},t.concat=function(t,e,n){const o=t.am*e.am,i=t.rm*e.rm,a=t.gm*e.gm,r=t.bm*e.bm,s=t.am*e.ao+t.ao,c=t.rm*e.ro+t.ro,h=t.gm*e.go+t.go,d=t.bm*e.bo+t.bo;n.am=o,n.rm=i,n.gm=a,n.bm=r,n.ao=s,n.ro=c,n.go=h,n.bo=d}}(k||(k={})),function(t){function e(t){return t.a*t.d-t.b*t.c}t.empty=function(){return{a:1,b:0,c:0,d:1,x:0,y:0}},t.concat=function(t,e,n){const o=e.a*t.a+e.b*t.c,i=e.a*t.b+e.b*t.d,a=e.c*t.a+e.d*t.c,r=e.c*t.b+e.d*t.d,s=e.x*t.a+e.y*t.c+t.x,c=e.x*t.b+e.y*t.d+t.y;n.a=o,n.b=i,n.c=a,n.d=r,n.x=s,n.y=c},t.getScale=function(t){return c(s(t.a),s(t.b),s(t.c),s(t.d))},t.transformPoint=function(t,e,n){const{x:o,y:i}=e;n.x=o*t.a+i*t.c,n.y=o*t.b+i*t.d},t.getDeterminant=e,t.transformInversePoint=function(t,n,o){let i=e(t);if(0===i)o.x=-t.x,o.y=-t.y;else{i=1/i;const{x:e,y:a}=n;o.x=i*(t.c*(t.y-a)+t.d*(e-t.x)),o.y=i*(t.a*(a-t.y)+t.b*(t.x-e))}}}(I||(I={}));const L=I.empty();var C;!function(t){function e(t,e){var n,o,i,a,r,s;const{rotation:c}=t,h=null!==(o=null!==(n=t.scaleX)&&void 0!==n?n:t.scale)&&void 0!==o?o:1,d=null!==(a=null!==(i=t.scaleY)&&void 0!==i?i:t.scale)&&void 0!==a?a:1;if(e.x=null!==(r=t.x)&&void 0!==r?r:0,e.y=null!==(s=t.y)&&void 0!==s?s:0,c){const t=Math.cos(c),n=Math.sin(c);return e.a=t*h,e.b=n*h,e.c=-n*d,void(e.d=t*d)}e.a=h,e.b=0,e.c=0,e.d=d}t.getMatrix=e,t.getColorTransform=function(t,e){var n;const o=null!==(n=t.alpha)&&void 0!==n?n:1,{tint:i}=t;if(i){const{color:t=0,value:n=1}=i,a=1-n,r=t>>16&255,s=t>>8&255,c=255&t;return e.am=o,e.rm=a,e.gm=a,e.bm=a,e.ao=0,e.ro=r*n,e.go=s*n,void(e.bo=c*n)}let{brightness:a}=t;if(void 0!==a){a>1?a=1:a<-1&&(a=-1);const t=1-Math.abs(a);let n=0;return a>0&&(n=255*a),e.am=o,e.rm=t,e.gm=t,e.bm=t,e.ao=0,e.ro=n,e.go=n,void(e.bo=n)}e.am=o,e.rm=1,e.gm=1,e.bm=1,e.ao=0,e.ro=0,e.go=0,e.bo=0},t.transformPoint=function(t,n,o){const{x:i,y:a}=n;e(t,L),o.x=i*L.a+a*L.c+L.x,o.y=i*L.b+a*L.d+L.y}}(C||(C={}));const K=e.create();var R;!function(t){t.render=function t(e,n,o,i){var a;if(e.onScreen=!1,!(null===(a=e.visible)||void 0===a||a))return;const r=I.empty();if(C.getMatrix(e,r),I.concat(n,r,r),e.radius){const t=I.getScale(r)*e.radius;if(r.x+t<0||r.y+t<0||r.x-t>i.canvas.width-0||r.y-t>i.canvas.height-0)return}const s=k.empty();if(C.getColorTransform(e,s),k.concat(o,s,s),s.am<=0)return;e.onScreen=!0,i.setTransform(r.a,r.b,r.c,r.d,r.x,r.y);const{shape:c,image:h,pallete:d,text:u,children:l}=e;c&&d&&function(t,e,n,o){for(let i=0;i<t.length;i++)switch(t[i]){case 0:o.fillStyle=m.transformColor(e[t[++i]],n),o.fill();break;case 1:o.strokeStyle=m.transformColor(e[t[++i]],n),o.lineWidth=t[++i],o.stroke();break;case 2:o.beginPath(),o.moveTo(t[++i],t[++i]);break;case 3:o.lineTo(t[++i],t[++i]);break;case 4:let a=t[++i];for(a--,o.beginPath(),o.moveTo(t[++i],t[++i]);a--;)o.lineTo(t[++i],t[++i]);break;default:throw`unknown command: ${t[i]}`}}(c,d,s,i),u&&function(t,e,n){var o,i,a;if(!t.value)return;n.fillStyle=m.transformColor(null!==(o=t.color)&&void 0!==o?o:4278190080,e),n.font=`${null!==(i=t.size)&&void 0!==i?i:10}px ${null!==(a=t.font)&&void 0!==a?a:"arial"}`,n.textBaseline="top";let r=0;t.align&&(r=-n.measureText(t.value).width*t.align),n.fillText(t.value,r,0)}(u,s,i),h&&function(t,e,n){n.fillStyle=n.createPattern(t,"no-repeat"),n.fillRect(0,0,t.width,t.height)}(h,0,i),l&&l.forEach((e=>t(e,r,s,i)))},t.update=function t(e,n){if(!1===e.enabled)return;e.onUpdate&&e.onUpdate(n);const{children:o}=e;o&&o.forEach((e=>t(e,n)))},t.keyProcess=function t(e,n,o){switch(o){case 1:e.onKeyDown&&e.onKeyDown(n);break;case 0:e.onKeyUp&&e.onKeyUp(n)}const{children:i}=e;i&&i.forEach((e=>t(e,n,o)))},t.touchProcess=function t(e,n,o,i){if(!1===e.touchable)return;const a=I.empty();switch(C.getMatrix(e,a),I.concat(o,a,a),i){case 1:e.onTouchDown&&(I.transformInversePoint(a,n,K),e.onTouchDown(K,n));case 0:e.onTouchUp&&(I.transformInversePoint(a,n,K),e.onTouchUp(K,n));case 2:e.onTouchMove&&(I.transformInversePoint(a,n,K),e.onTouchMove(K,n))}const{children:r}=e;r&&r.forEach((e=>t(e,n,a,i)))}}(R||(R={}));const _=I.empty(),D=k.empty(),U=devicePixelRatio;var Y;!function(t){let e,n;t.render=function(t){!function(){const t=innerWidth*U|0,e=innerHeight*U|0;t!==n.width&&(n.width=t);e!==n.height&&(n.height=e);_.a=_.d=U}(),e.setTransform(),e.fillStyle="#bbbbbb",e.fillRect(0,0,n.width,n.height),R.render(t,_,D,e)},t.init=function(t){n=t,e=n.getContext("2d")}}(Y||(Y={}));var $=function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function r(t){try{c(o.next(t))}catch(t){a(t)}}function s(t){try{c(o.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}c((o=o.apply(t,e||[])).next())}))};const q=document.getElementById("c");let N;Y.init(q);let O=performance.now();function W(){requestAnimationFrame(W);const t=function(){const t=performance.now(),e=t-O;return O=t,e/1e3}();R.update(N,t),N.updateView(t),Y.render(N)}function X(){N=function(t){const e=M();return{children:[e],updateView(n){const o=t.getWidth(),i=t.getHeight(),a=h(o/1024,i/1024);e.scale=a,e.x=o/2,e.y=i/2,e.updateCamera(n)}}}({getWidth:()=>innerWidth,getHeight:()=>innerHeight}),O=performance.now(),W(),document.addEventListener("keydown",(t=>{R.keyProcess(N,t,1),t.preventDefault()})),document.addEventListener("keyup",(t=>{R.keyProcess(N,t,0),t.preventDefault()})),q.addEventListener("mousedown",(t=>{const e={x:t.clientX*U,y:t.clientY*U};R.touchProcess(N,e,_,1)})),q.addEventListener("mouseup",(t=>{const e={x:t.clientX*U,y:t.clientY*U};R.touchProcess(N,e,_,0)})),q.addEventListener("mousemove",(t=>{const e={x:t.clientX*U,y:t.clientY*U};R.touchProcess(N,e,_,2)}))}!function(){$(this,void 0,void 0,(function*(){X()}))}()}();
