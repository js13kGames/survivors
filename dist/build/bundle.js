!function(){"use strict";function t(t){const{x:e,y:n}=t;return e*e+n*n}var e;!function(e){function n(t){return Math.hypot(t.x,t.y)}e.create=function(t=0,e=0){return{x:t,y:e}},e.vector=function(t,e){return{x:e.x-e.x,y:e.y-t.y}},e.distanceSquared=function(t,e){const n=t.x-e.x,o=t.y-e.y;return n*n+o*o},e.distance=function(t,e){return Math.hypot(t.x-e.x,t.y-e.y)},e.lengthSquared=t,e.length=n,e.normalize=function(t,e){let o=n(t);o>0&&(o=e/o,t.x*=o,t.y*=o)},e.copy=function(t,e){e.x=t.x,e.y=t.y}}(e||(e={}));const n=Math.round,o=Math.random,i=Math.sin,a=Math.cos,s=Math.atan2,r=Math.abs,c=Math.max,u=Math.min,l=Math.sqrt,h=2*Math.PI;function d(t,e){return n(t+o()*(e-t))}function f(t,e){return t+o()*(e-t)}var p;!function(t){t.transformColor=function(t,e){let n=t>>24&255,o=t>>16&255,i=t>>8&255,a=255&t;return n=n*e.am+e.ao&255,o=o*e.rm+e.ro&255,i=i*e.gm+e.go&255,a=a*e.bm+e.bo&255,`rgba(${o}, ${i}, ${a}, ${n/255})`},t.formatColor=function(t){return`rgba(${t>>16&255}, ${t>>8&255}, ${255&t}, ${(t>>24&255)/255})`}}(p||(p={}));function y(t,e,n,s,r,c,u,l,h){let f=d(r,c);t.push(4,f);const p=2*Math.PI/f;for(void 0===h&&(h=Math.PI*o());f--;)t.push(n+i(h)*d(u,l),s+a(h)*d(u,l)),h+=p;t.push(0,e)}class m{constructor(t){this.actions=new Map,this.transitions=[],this._state=-1,this._reactionTime=0,this._time=0,this._reactionTime=t}setState(t,e){this._state=t;const n=this.getAction();n&&n.start(e)}getAction(){const t=this.actions.get(this._state);if(!t)throw"Action not found: "+this._state;return t}update(t){const e=this.getAction();if(e&&e.update(t),this._time-=t,this._time<=0){this._time=this._reactionTime+this._reactionTime*o();for(const t of this.transitions){const{from:e,to:n}=t;if(n!==this._state&&(0===e.length||e.includes(this._state))&&t.condition()){this.setState(n,t.data);break}}}}}var g;!function(t){t[t.PLAYER=0]="PLAYER",t[t.NPC=1]="NPC",t[t.ENEMY=2]="ENEMY",t[t.NEUTRAL=3]="NEUTRAL"}(g||(g={}));const x=new Map;function v(t,e){return t===e||x.get(t)===e}function w(t){const{radius:e,weight:n,color:o,type:i,health:a}=t,s=[o,4278190080],r=new m(t.reaction),c={radius:e,weight:n},u=[];return y(u,0,0,0,5,5,e,e,Math.PI/10),y(u,1,e/2,0,3,3,e/3,e/3,Math.PI/2),{type:i,shape:u,pallete:s,rotation:0,x:0,y:0,fsm:r,body:c,health:a,settings:t,weapon:0,onUpdate(t){this.fsm.update(t)}}}function b(t,n,o,s,r,c){const u={x:s.speed*a(o),y:s.speed*i(o)};let l=0;const h=e.length(u),{length:d,width:f,color:p}=s,y=f/2,m={x:t,y:n,rotation:o,body:{weight:0,radius:3,transparent:!0},shape:[4,3,-d,0,0,-y,0,y,0,0],pallete:[p],onUpdate(t){this.x+=u.x*t,this.y+=u.y*t,l+=h*t,l>s.distance&&c.removeBullet(m)},onCollision(t,n){if("health"in t){const n=t;if(!v(n.type,r)&&(n.health-=s.damage/s.points.length,c.removeBullet(m),s.impulse)){const t=e.create(u.x,u.y);e.normalize(t,s.impulse),c.addImpulse({target:n,value:t})}}}};return m}function k(t,e){let n=0,o=0;return(s,r)=>{if(r&&t.settings.weapons){const r=t.settings.weapons[t.weapon];if(n-=s,n<=0){n=1/r.frequency;const{rotation:s,type:c}=t;if(r.angle){let n=s-r.angle/2;const o=r.angle/r.points.length;for(const s of r.points){const u=a(n),l=i(n),{x:h,y:d}=s,f=b(t.x+h*u-d*l,t.y+h*l+d*u,n,r,c,e);e.addBullet(f),n+=o}}else{o++,o>=r.points.length&&(o=0);const n=a(s),u=i(s),{x:l,y:h}=r.points[o],d=b(t.x+l*n-h*u,t.y+l*u+h*n,s,r,c,e);e.addBullet(d)}}}else n=0}}var A,E,T,C,S;function M(t,e){const n=w(t),{walkSpeed:s}=t;n.rotation=h*o();const{fsm:r}=n,{actions:c,transitions:u}=r;return c.set(0,{update(t){n.rotation+=this.data.speed*t,this.data.time-=t},start(){this.data={speed:o()>.5?-1:1,time:f(.5,2)}}}),c.set(1,{update(t){n.x+=this.data.speedX*t,n.y+=this.data.speedY*t,this.data.time-=t},start(){this.data={speedX:a(n.rotation)*s,speedY:i(n.rotation)*s,time:f(1,3)}}}),c.set(3,{update(t){n.alpha-=t,n.alpha<0&&e.removeUnit(n)},start(){n.alpha=.9,n.body.enabled=!1}}),u.push({from:[1],to:0,condition:()=>n.x<-500?(n.x+=5,!0):n.x>500?(n.x-=5,!0):n.y<-500?(n.y+=5,!0):n.y>500?(n.y-=5,!0):r.getAction().data.time<0}),u.push({from:[0],to:1,condition:()=>r.getAction().data.time<0}),u.push({from:[],to:3,condition:()=>n.health<=0}),r.setState(0),n}function P(t,n){return{damage:n,speed:100,points:[e.create(t,0)],frequency:1,distance:20,color:4294901760,length:20,width:20,impulse:3}}function L(t){return{damage:20,points:[e.create(t,0)],frequency:3,speed:1e3,distance:1e3,color:4294967295,length:30,width:4,impulse:5}}function I(t){return{damage:40,points:[e.create(t,-5),e.create(t,5)],frequency:10,speed:1500,distance:1e3,color:4294967040,length:50,width:3,impulse:3}}function U(t){return{damage:150,points:new Array(10).fill(e.create(t,0)),frequency:1,speed:1e3,distance:300,color:4278255615,length:10,width:3,angle:.7,impulse:5}}function D(t){var e;return(0,(e=[L,I,U])[d(0,e.length-1)])(t)}function O(t,n){const o=e.distanceSquared(t,n),i=n.body.radius+t.body.radius;return o<1.1*(i*i)}function R(t){const n=f(25,45),r={type:2,radius:n,weight:3*n,health:4*n,color:4288217088,walkSpeed:f(80,150),reaction:.5,weapons:[P(n,n)]},c=M(r,t),{walkSpeed:u}=r,l=400;c.rotation=h*o();const{fsm:d}=c,{actions:p,transitions:y}=d,m=k(c,t);return p.set(10,{update(t){c.rotation=s(this.data.target.y-c.y,this.data.target.x-c.x);const e=a(c.rotation)*u,n=i(c.rotation)*u;c.x+=e*t,c.y+=n*t},start(t){this.data={target:t}}}),p.set(11,{update(t){m(t,!0)},start(t){this.data={target:t}}}),y.push({from:[0,1],to:10,condition(){const e=t.getNearOpponent(c,l);return!!e&&(this.data=e,!0)}}),y.push({from:[10,11],to:0,condition(){const n=d.getAction().data.target;if(n.health<=0)return!0;if(e.distanceSquared(n,c)>24e4)return!0;return t.getNearOpponent(c,l)!=n}}),y.push({from:[10],to:11,condition(){const t=d.getAction().data.target;return!!O(t,c)&&(this.data=t,!0)}}),y.push({from:[11],to:10,condition(){const t=d.getAction().data.target;return!O(t,c)&&(this.data=t,!0)}}),c}function B(t){const n={type:1,radius:30,weight:90,health:100,color:4288256256,walkSpeed:200,reaction:.2,weapons:[D(30)]},o=M(n,t),{fsm:i}=o,{actions:a,transitions:r}=i,{units:c}=t,{walkSpeed:u}=n,l=200,h=k(o,t);return a.set(10,{update(t){const n=this.data.target;o.rotation=s(n.y-o.y,n.x-o.x);const i=function(t,n,o,i){let{x:a,y:s}=t,r=1;for(const c of n)if(!v(c.type,t.type)){const n=e.vector(c,t);e.lengthSquared(n)<i&&(e.normalize(n,o),a+=n.x,s+=n.y,r++)}return r>1?(a/=r,s/=r,{x:a,y:s}):null}(o,c,l,4e4);if(i){const n=e.vector(o,i);e.lengthSquared(n)>u&&(e.normalize(n,u),o.x+=n.x*t,o.y+=n.y*t)}h(t,!0)},start(t){this.data={target:t}}}),r.push({from:[0,1],to:10,condition(){let e=t.getNearOpponent(o,l);return!!e&&(this.data=e,!0)}}),r.push({from:[10],to:0,condition(){const t=i.getAction().data.target;if(t.health<=0)return!0;return e.distanceSquared(t,o)>6e4}}),o}x.set(1,0),x.set(0,1),function(t){t[t.ROTATE=0]="ROTATE",t[t.WALK=1]="WALK",t[t.DEAD=3]="DEAD"}(A||(A={})),function(t){t[t.GOTO_TARGET=10]="GOTO_TARGET",t[t.ATTACK=11]="ATTACK"}(E||(E={})),function(t){t[t.ATTACK=10]="ATTACK"}(T||(T={})),function(t){t[t.ALIVE=0]="ALIVE",t[t.DEAD=1]="DEAD"}(C||(C={})),function(t){t[t.SIZE=0]="SIZE",t[t.FILL=1]="FILL",t[t.RECTANGLE=2]="RECTANGLE",t[t.ELLIPSE=3]="ELLIPSE",t[t.LINE=4]="LINE",t[t.REPEAT=5]="REPEAT",t[t.NOISE=6]="NOISE"}(S||(S={}));const q=new Map;q.set(0,((t,e,n)=>{const o=n.fillStyle;e.width=t.width,e.height=t.height,n.fillStyle=o,n.fillRect(0,0,e.width,e.height)})),q.set(1,((t,e,n)=>{n.fillStyle=p.formatColor(t.color)})),q.set(2,((t,e,n)=>{n.fillRect(t.x,t.y,t.width,t.height)})),q.set(3,((t,e,n)=>{const o=t.width/2,i=t.height/2;n.beginPath(),n.ellipse(t.x+o,t.y+i,o,i,0,0,2*Math.PI),n.closePath(),n.fill()})),q.set(5,((t,e,n,o)=>{const i=q.get(o.type),a=o.x,s=t.stepX,r=t.stepY,c=t.cols;let u=t.count,l=1;for(o.x+=s;u--;)i(o,e,n,o),o.x+=s,l++,l===c&&(l=0,o.x=a,o.y+=r)})),q.set(6,((t,e,n)=>{const i=t.colorOffset,a=i/2,s=n.getImageData(0,0,e.width,e.height),r=s.data;let c=0;for(;c<r.length;){const t=r[c],e=r[c+1],n=r[c+2];r[c]=t-a+i*o(),r[c+1]=e-a+i*o(),r[c+2]=n-a+i*o(),c+=4}n.putImageData(s,0,0)}));const K=[{type:1,color:4284900966},{type:0,width:512,height:512},{type:1,color:4286023799},{type:2,x:20,y:20,width:50,height:50},{type:5,stepX:70,stepY:70,count:48,cols:7},{type:1,color:4284900966},{type:2,x:140,y:140,width:220,height:220},{type:1,color:4286023799},{type:3,x:160,y:160,width:190,height:190}];function N(){const t=512,e={image:function(t){const e=document.createElement("canvas"),n=e.getContext("2d");let o;return t.forEach((t=>{q.get(t.type)(t,e,n,o),o=t})),e}(K),x:-256,y:-256},n=Math.hypot(t)/2,o=[];for(let t=0;t<10;t++)for(let i=0;i<10;i++)o.push({x:511*(t-5),y:511*(i-5),radius:n,children:[e]});return{children:o}}const W=e.create();function _(){const n=[],o=[],i=[],a=[],s=[];return{units:o,children:[N(),{children:s,touchable:!1},{children:o,touchable:!1},{children:i,touchable:!1}],onUpdate(o){!function(n,o){for(let o=0;o<n.length;o++){const i=n[o],a=i.body;if(!1!==a.enabled)for(let s=o+1;s<n.length;s++){const o=n[s],r=o.body;if(!1!==r.enabled){const n=a.radius+r.radius,s=n*n;i.x==o.x&&i.y===o.y&&(i.x+=.001),W.x=i.x-o.x,W.y=i.y-o.y;const c=t(W);if(c<s){if(!a.transparent&&!r.transparent){a.points,r.points;const t=l(c),e=(n-t)/t,s=W.x*e,u=W.y*e;let h=0,d=0;if(a.static)d=1;else if(r.static)h=1;else{const t=a.weight,e=r.weight,n=t+e;h=e/n,d=t/n}i.x+=s*h,i.y+=u*h,o.x-=s*d,o.y-=u*d}(i.onCollision||o.onCollision)&&(W.x=i.x-o.x,W.y=i.y-o.y,e.normalize(W,r.radius),W.x+=o.x,W.y+=o.y),i.onCollision&&i.onCollision(o,W),o.onCollision&&o.onCollision(i,W)}}}}}(n),function(t,n){for(const o of t){const{target:i,value:a}=o;i.x+=a.x,i.y+=a.y;const{weight:s}=i.body;let r=e.length(a);r-=r*s/4*n,r<.5?t.splice(t.indexOf(o)):e.normalize(a,r)}}(a,o)},addObject(t){s.push(t),n.push(t)},removeObject(t){s.splice(s.indexOf(t),1),n.splice(n.indexOf(t),1)},addUnit(t){o.push(t),n.push(t)},removeUnit(t){o.splice(o.indexOf(t),1),n.splice(n.indexOf(t),1)},getUnitCount(t){let e=0;for(const n of this.units)n.type===t&&e++;return e},getNearOpponent(t,n){let i=null,a=n*n;for(const n of o)if(!v(n.type,t.type)&&n.health>0){const o=e.distanceSquared(n,t);o<a&&(a=o,i=n)}return i},addBullet(t){i.push(t),n.push(t)},removeBullet(t){i.splice(i.indexOf(t),1),n.splice(n.indexOf(t),1)},addImpulse(t){a.push(t)}}}const z="ontouchstart"in window;class Y{constructor(t){this.direction=e.create(),this.attack=!1,this.rotation=0,this.weapon=0,t.setActiveWeapon(this.weapon),t.gunButton.onClick=()=>{this.weapon=0,t.setActiveWeapon(t.gunButton)},t.rifleButton.onClick=()=>{this.weapon=1,t.setActiveWeapon(t.rifleButton)},t.shotgunButton.onClick=()=>{this.weapon=2,t.setActiveWeapon(t.shotgunButton)}}}class $ extends Y{constructor(t,n){super(t),n.onTouchMove=t=>{this.rotation=s(t.y-this.player.y,t.x-this.player.x)},n.onTouchDown=t=>{this.attack=!0},n.onTouchUp=t=>{this.attack=!1};let o=!1,i=!1,a=!1,r=!1;const c=n=>{const s="keydown"===n.type;switch(n.code){case"KeyW":case"ArrowUp":o=s;break;case"KeyS":case"ArrowDown":i=s;break;case"KeyA":case"ArrowLeft":r=s;break;case"KeyD":case"ArrowRight":a=s;break;case"Space":s&&this.player.settings.weapons&&(this.weapon++,this.weapon>=this.player.settings.weapons.length&&(this.weapon=0),t.setActiveWeapon(this.weapon))}this.direction.x=0,this.direction.y=0,o&&(this.direction.y-=1),i&&(this.direction.y+=1),r&&(this.direction.x-=1),a&&(this.direction.x+=1),e.normalize(this.direction,1)};n.onKeyDown=c,n.onKeyUp=c}}class V extends Y{constructor(t){super(t),t.moveJoystick.onChange=()=>{e.copy(t.moveJoystick.value,this.direction),e.normalize(this.direction,1)},t.attackJoystick.onChange=()=>{const{value:e}=t.attackJoystick;this.attack=t.attackJoystick.isActive(),this.attack&&(this.rotation=s(e.y,e.x))}}}function J(t,n,o,i){let a=100;for(;;){t.x=f(o,i),t.y=f(o,i);let s=!0;for(const o of n)if(!v(o.type,t.type)&&e.distanceSquared(t,o)<4e4){s=!1;break}if(s)break;if(a--<0)break}}function X(t){const n=e.create(),o=_(),i=function(t,e){return z?new V(e):new $(e,t)}(o,t),a=function(t,e){const n={type:0,radius:30,weight:90,health:100,color:4278229401,walkSpeed:200,reaction:.2,weapons:[L(30),I(30),U(30)]},o=w(n),{fsm:i}=o,{actions:a,transitions:s}=i,{walkSpeed:r}=n,c=k(o,t);return a.set(0,{update(t){const n=r*t;o.x+=e.direction.x*n,o.y+=e.direction.y*n,o.rotation=e.rotation,o.weapon=e.weapon,c(t,e.attack)},start(){}}),a.set(1,{update(){},start(){o.alpha=.5,o.body.enabled=!1}}),s.push({from:[],to:1,condition:()=>o.health<=0}),i.setState(0),o}(o,i);i.player=a,o.addUnit(a);const s=600;for(let t=0;t<30;t++){const t=R(o);J(t,o.units,-600,s),o.addUnit(t)}const r=300;for(let t=0;t<10;t++){const t=B(o);t.x=f(-300,r),t.y=f(-300,r),o.addUnit(t)}const l=[];y(l,0,0,0,10,10,100,100);const h={x:512,y:0,rotation:0,pallete:[4284874854],shape:l,body:{weight:0,static:!0,radius:100}};o.addObject(h);return{camera:n,children:[o],size:2500,onUpdate(){if(o.getUnitCount(2)<30){const t=R(o);J(t,o.units,-600,s),o.addUnit(t)}},updateCamera(){var t;this.camera.x=a.x,this.camera.y=a.y,null===(t=this.children)||void 0===t||t.forEach((t=>{o.x=-this.camera.x,o.y=-this.camera.y}))},calculateVolume(t){const o=e.distance(n,t);return 1-u(1,c(0,o/1250))}}}function G(t,e,n){const o=document.createElement("canvas");o.width=o.height=2*t;const i=o.getContext("2d");return i.strokeStyle=e,i.globalAlpha=.5,i.lineWidth=n,i.beginPath(),i.arc(t,t,t-n,0,h),i.stroke(),o}const H=G(50,"#fff",5),j=4290493371;function F(t){const e={text:{value:t,font:"arial",size:30,align:.5,color:j},x:50,y:35};return{children:[{image:H},e],onTouchDown(t){0<t.x&&t.x<100&&0<t.y&&t.y<100&&this.onClick&&this.onClick()},setActive(t){e.text.color=t?4294967295:j}}}const Z=150,Q=G(Z,"#fff",5),tt=G(60,"#fff",5);function et(){const t={image:Q},n={image:tt};t.x=-150,t.y=-150;let o=-1;return{children:[t,n],radius:Z,value:e.create(),isActive:()=>-1!=o,onUpdate(){n.x=this.value.x*Z-60,n.y=this.value.y*Z-60},onTouchDown(t,n,i){-1===o&&e.length(t)<Z&&(o=i,this.updateValue(t))},onTouchUp(t,e,n){o===n&&(o=-1,this.value.x=0,this.value.y=0,this.onChange&&this.onChange())},onTouchMove(t,e,n){o===n&&this.updateValue(t)},updateValue(t){this.value.x=t.x/Z,this.value.y=t.y/Z,e.length(this.value)>1&&e.normalize(this.value,1),this.onChange&&this.onChange()}}}const nt=30;function ot(t){const e=function(t){const e=et(),n=et(),o=F("gun"),i=F("rifle"),a=F("shot");e.visible=z,n.visible=z;const s=[o,i,a];return{moveJoystick:e,attackJoystick:n,gunButton:o,rifleButton:i,shotgunButton:a,children:[e,n,o,i,a],onUpdate(){const s=t.getWidth()/this.scale,r=t.getHeight()/this.scale;e.x=nt+e.radius,e.y=r-nt-e.radius,n.x=s-nt-n.radius,n.y=r-nt-n.radius,z?(a.x=s-nt-150,a.y=r-nt-2*n.radius-150,i.x=a.x-150,i.y=a.y+20,o.x=i.x-120,o.y=i.y+100):(a.x=s-nt-100,a.y=r-nt-100,i.x=a.x-100-nt,i.y=a.y,o.x=i.x-100-nt,o.y=i.y)},setActiveWeapon(t){"number"==typeof t&&(t=s[t]),s.forEach((e=>{e.setActive(e===t)}))}}}(t),n=X(e);return{children:[n,e],updateView(o){const i=t.getWidth(),a=t.getHeight(),s=u(i/1024,a/1024);n.scale=s,n.x=i/2,n.y=a/2,e.scale=s,n.updateCamera(o)}}}var it,at;!function(t){t.empty=function(){return{am:1,rm:1,gm:1,bm:1,ao:0,ro:0,go:0,bo:0}},t.concat=function(t,e,n){const o=t.am*e.am,i=t.rm*e.rm,a=t.gm*e.gm,s=t.bm*e.bm,r=t.am*e.ao+t.ao,c=t.rm*e.ro+t.ro,u=t.gm*e.go+t.go,l=t.bm*e.bo+t.bo;n.am=o,n.rm=i,n.gm=a,n.bm=s,n.ao=r,n.ro=c,n.go=u,n.bo=l}}(it||(it={})),function(t){function e(t){return t.a*t.d-t.b*t.c}t.empty=function(){return{a:1,b:0,c:0,d:1,x:0,y:0}},t.concat=function(t,e,n){const o=e.a*t.a+e.b*t.c,i=e.a*t.b+e.b*t.d,a=e.c*t.a+e.d*t.c,s=e.c*t.b+e.d*t.d,r=e.x*t.a+e.y*t.c+t.x,c=e.x*t.b+e.y*t.d+t.y;n.a=o,n.b=i,n.c=a,n.d=s,n.x=r,n.y=c},t.getScale=function(t){return c(r(t.a),r(t.b),r(t.c),r(t.d))},t.transformPoint=function(t,e,n){const{x:o,y:i}=e;n.x=o*t.a+i*t.c,n.y=o*t.b+i*t.d},t.getDeterminant=e,t.transformInversePoint=function(t,n,o){let i=e(t);if(0===i)o.x=-t.x,o.y=-t.y;else{i=1/i;const{x:e,y:a}=n;o.x=i*(t.c*(t.y-a)+t.d*(e-t.x)),o.y=i*(t.a*(a-t.y)+t.b*(t.x-e))}}}(at||(at={}));const st=at.empty();var rt;!function(t){function e(t,e){var n,o,i,a,s,r;const{rotation:c}=t,u=null!==(o=null!==(n=t.scaleX)&&void 0!==n?n:t.scale)&&void 0!==o?o:1,l=null!==(a=null!==(i=t.scaleY)&&void 0!==i?i:t.scale)&&void 0!==a?a:1;if(e.x=null!==(s=t.x)&&void 0!==s?s:0,e.y=null!==(r=t.y)&&void 0!==r?r:0,c){const t=Math.cos(c),n=Math.sin(c);return e.a=t*u,e.b=n*u,e.c=-n*l,void(e.d=t*l)}e.a=u,e.b=0,e.c=0,e.d=l}t.getMatrix=e,t.getColorTransform=function(t,e){var n;const o=null!==(n=t.alpha)&&void 0!==n?n:1,{tint:i}=t;if(i){const{color:t=0,value:n=1}=i,a=1-n,s=t>>16&255,r=t>>8&255,c=255&t;return e.am=o,e.rm=a,e.gm=a,e.bm=a,e.ao=0,e.ro=s*n,e.go=r*n,void(e.bo=c*n)}let{brightness:a}=t;if(void 0!==a){a>1?a=1:a<-1&&(a=-1);const t=1-Math.abs(a);let n=0;return a>0&&(n=255*a),e.am=o,e.rm=t,e.gm=t,e.bm=t,e.ao=0,e.ro=n,e.go=n,void(e.bo=n)}e.am=o,e.rm=1,e.gm=1,e.bm=1,e.ao=0,e.ro=0,e.go=0,e.bo=0},t.transformPoint=function(t,n,o){const{x:i,y:a}=n;e(t,st),o.x=i*st.a+a*st.c+st.x,o.y=i*st.b+a*st.d+st.y}}(rt||(rt={}));const ct=e.create();var ut;!function(t){t.render=function t(e,n,o,i){var a;if(e.onScreen=!1,!(null===(a=e.visible)||void 0===a||a))return;const s=at.empty();if(rt.getMatrix(e,s),at.concat(n,s,s),e.radius){const t=at.getScale(s)*e.radius;if(s.x+t<0||s.y+t<0||s.x-t>i.canvas.width-0||s.y-t>i.canvas.height-0)return}const r=it.empty();if(rt.getColorTransform(e,r),it.concat(o,r,r),r.am<=0)return;e.onScreen=!0,i.setTransform(s.a,s.b,s.c,s.d,s.x,s.y);const{shape:c,image:u,pallete:l,text:h,children:d}=e;c&&l&&function(t,e,n,o){for(let i=0;i<t.length;i++)switch(t[i]){case 0:o.fillStyle=p.transformColor(e[t[++i]],n),o.fill();break;case 1:o.strokeStyle=p.transformColor(e[t[++i]],n),o.lineWidth=t[++i],o.stroke();break;case 2:o.beginPath(),o.moveTo(t[++i],t[++i]);break;case 3:o.lineTo(t[++i],t[++i]);break;case 4:let a=t[++i];for(a--,o.beginPath(),o.moveTo(t[++i],t[++i]);a--;)o.lineTo(t[++i],t[++i]);break;default:throw`unknown command: ${t[i]}`}}(c,l,r,i),h&&function(t,e,n){var o,i,a;if(!t.value)return;n.fillStyle=p.transformColor(null!==(o=t.color)&&void 0!==o?o:4278190080,e),n.font=`${null!==(i=t.size)&&void 0!==i?i:10}px ${null!==(a=t.font)&&void 0!==a?a:"arial"}`,n.textBaseline="top";let s=0;t.align&&(s=-n.measureText(t.value).width*t.align),n.fillText(t.value,s,0)}(h,r,i),u&&function(t,e,n){n.fillStyle=n.createPattern(t,"no-repeat"),n.fillRect(0,0,t.width,t.height)}(u,0,i),d&&d.forEach((e=>t(e,s,r,i)))},t.update=function t(e,n){if(!1===e.enabled)return;e.onUpdate&&e.onUpdate(n);const{children:o}=e;o&&o.forEach((e=>t(e,n)))},t.keyProcess=function t(e,n,o){switch(o){case 1:e.onKeyDown&&e.onKeyDown(n);break;case 0:e.onKeyUp&&e.onKeyUp(n)}const{children:i}=e;i&&i.forEach((e=>t(e,n,o)))},t.touchProcess=function t(e,n,o,i,a){if(!1===e.touchable)return;const s=at.empty();switch(rt.getMatrix(e,s),at.concat(o,s,s),i){case 1:e.onTouchDown&&(at.transformInversePoint(s,n,ct),e.onTouchDown(ct,n,a));break;case 0:e.onTouchUp&&(at.transformInversePoint(s,n,ct),e.onTouchUp(ct,n,a));break;case 2:e.onTouchMove&&(at.transformInversePoint(s,n,ct),e.onTouchMove(ct,n,a))}const{children:r}=e;r&&r.forEach((e=>t(e,n,s,i,a)))}}(ut||(ut={}));const lt=at.empty(),ht=it.empty(),dt=devicePixelRatio;var ft;!function(t){let e,n;t.render=function(t){!function(){const t=innerWidth*dt|0,e=innerHeight*dt|0;t!==n.width&&(n.width=t);e!==n.height&&(n.height=e);lt.a=lt.d=dt}(),e.setTransform(),e.fillStyle="#bbbbbb",e.fillRect(0,0,n.width,n.height),ut.render(t,lt,ht,e)},t.init=function(t){n=t,e=n.getContext("2d")}}(ft||(ft={}));var pt=function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function s(t){try{c(o.next(t))}catch(t){a(t)}}function r(t){try{c(o.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,r)}c((o=o.apply(t,e||[])).next())}))};const yt=document.getElementById("c");let mt;ft.init(yt);let gt=performance.now();function xt(){requestAnimationFrame(xt);const t=function(){const t=performance.now(),e=t-gt;return gt=t,e/1e3}();ut.update(mt,t),mt.updateView(t),ft.render(mt)}!function(){pt(this,void 0,void 0,(function*(){!function(){if(mt=ot({getWidth:()=>innerWidth,getHeight:()=>innerHeight}),gt=performance.now(),xt(),document.addEventListener("keydown",(t=>{ut.keyProcess(mt,t,1),t.preventDefault()})),document.addEventListener("keyup",(t=>{ut.keyProcess(mt,t,0),t.preventDefault()})),z){const t=new Map([["touchstart",1],["touchend",0],["touchcancel",0],["touchmove",2]]);function e(e){const n=t.get(e.type);for(let t=0;t<e.changedTouches.length;t++){const o=e.changedTouches[t],i={x:o.clientX*dt,y:o.clientY*dt};ut.touchProcess(mt,i,lt,n,o.identifier)}e.preventDefault()}yt.addEventListener("touchstart",e,!1),yt.addEventListener("touchend",e,!1),yt.addEventListener("touchcancel",e,!1),yt.addEventListener("touchmove",e,!1)}else{const t=new Map([["mousedown",1],["mouseup",0],["mouseleave",0],["mousemove",2]]);function e(e){const n=t.get(e.type),o={x:e.clientX*dt,y:e.clientY*dt};ut.touchProcess(mt,o,lt,n,0),e.preventDefault()}yt.addEventListener("mousedown",e),yt.addEventListener("mousemove",e),yt.addEventListener("mouseup",e),yt.addEventListener("mouseleave",e)}}()}))}()}();
